<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能知识管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* 目录树样式 */
        .directory-tree {
            width: 300px;
            background: #f5f7fa;
            padding: 20px;
            border-right: 1px solid #e4e7ed;
            overflow-y: auto;
        }

        .tree-node {
            margin-left: 20px;
            position: relative;
        }

        .node-content {
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .node-content:hover {
            background: #ebedf0;
            border-radius: 4px;
        }

        .node-icon {
            margin-right: 8px;
            transition: transform 0.3s;
        }

        .node-icon.collapsed {
            transform: rotate(-90deg);
        }

        .children-container {
            display: none;
            margin-left: 15px;
        }

        .children-container.show {
            display: block;
        }

        /* 操作按钮 */
        .node-actions {
            margin-left: auto;
            display: none;
        }

        .node-content:hover .node-actions {
            display: block;
        }

        .action-btn {
            padding: 2px 6px;
            margin-left: 5px;
            cursor: pointer;
            color: #409eff;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            width: 400px;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
        }

        .modal-footer {
            text-align: right;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background: #409eff;
            color: white;
        }

        .btn-secondary {
            background: #909399;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 目录树区域 -->
        <div class="directory-tree" id="directoryTree"></div>
        
        <!-- 添加按钮 -->
        <button class="btn btn-primary" style="position: fixed; bottom: 20px; right: 20px;" 
                onclick="showAddModal(null)">添加根目录</button>
        
        <!-- 模态框 -->
        <div class="modal" id="addModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">添加新项目</h3>
                <div class="form-group">
                    <label>类型</label>
                    <select class="form-control" id="nodeType" onchange="updateParentSelect()">
                        <option value="subject">科目</option>
                        <option value="book">书本</option>
                        <option value="unit">单元</option>
                        <option value="knowledge">知识点</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" class="form-control" id="nodeName">
                </div>
                <div class="form-group" id="parentSelectContainer">
                    <label>父级</label>
                    <select class="form-control" id="parentSelect"></select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideModal()">取消</button>
                    <button class="btn btn-primary" onclick="confirmAdd()">确认</button>
                </div>
            </div>
        </div>
    </div>

<script>
// 数据结构示例
let treeData = [
    {
        id: 1,
        type: 'subject',
        name: '数学',
        children: [
            {
                id: 2,
                type: 'book',
                name: '七年级上册',
                children: [
                    {
                        id: 3,
                        type: 'unit',
                        name: '第一单元 有理数',
                        children: [
                            { id: 4, type: 'knowledge', name: '正数和负数' }
                        ]
                    }
                ]
            }
        ]
    }
];

// 生成唯一ID
let nextId = 5;

// 递归渲染树节点
function renderTree(data, parentElement, level = 0) {
    parentElement.innerHTML = '';
    data.forEach(node => {
        const nodeElement = document.createElement('div');
        nodeElement.className = 'tree-node';
        nodeElement.dataset.id = node.id;

        const nodeContent = document.createElement('div');
        nodeContent.className = 'node-content';
        
        // 添加图标
        const icon = document.createElement('span');
        icon.className = 'node-icon';
        icon.innerHTML = '▸';
        if (node.children && node.children.length > 0) {
            icon.addEventListener('click', () => toggleCollapse(nodeElement));
        } else {
            icon.style.visibility = 'hidden';
        }

        // 节点名称
        const nameSpan = document.createElement('span');
        nameSpan.textContent = node.name;

        // 操作按钮
        const actions = document.createElement('div');
        actions.className = 'node-actions';
        actions.innerHTML = `
            <span class="action-btn" onclick="showAddModal(${node.id})">添加</span>
            <span class="action-btn" onclick="deleteNode(${node.id})">删除</span>
        `;

        nodeContent.appendChild(icon);
        nodeContent.appendChild(nameSpan);
        nodeContent.appendChild(actions);
        nodeElement.appendChild(nodeContent);

        // 递归渲染子节点
        if (node.children && node.children.length > 0) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'children-container';
            renderTree(node.children, childrenContainer, level + 1);
            nodeElement.appendChild(childrenContainer);
        }

        parentElement.appendChild(nodeElement);
    });
}

// 切换展开/收起
function toggleCollapse(nodeElement) {
    const icon = nodeElement.querySelector('.node-icon');
    const childrenContainer = nodeElement.querySelector('.children-container');
    icon.classList.toggle('collapsed');
    childrenContainer.classList.toggle('show');
}

// 显示添加模态框
let selectedParentId = null;
function showAddModal(parentId) {
    selectedParentId = parentId;
    document.getElementById('addModal').style.display = 'block';
    updateParentSelect();
}

// 更新父级选择器
function updateParentSelect() {
    const type = document.getElementById('nodeType').value;
    const parentSelect = document.getElementById('parentSelect');
    parentSelect.innerHTML = '';

    // 根据类型过滤可选的父级
    const validParentTypes = {
        subject: null,
        book: 'subject',
        unit: 'book',
        knowledge: 'unit'
    }[type];

    // 递归查找符合条件的节点
    function findValidNodes(nodes, typeFilter) {
        return nodes.flatMap(node => {
            const valid = !typeFilter || node.type === typeFilter;
            return [
                ...(valid ? [{ id: node.id, name: node.name }] : []),
                ...findValidNodes(node.children || [], typeFilter)
            ];
        });
    }

    const validNodes = findValidNodes(treeData, validParentTypes);
    validNodes.forEach(node => {
        const option = document.createElement('option');
        option.value = node.id;
        option.textContent = node.name;
        parentSelect.appendChild(option);
    });

    // 显示/隐藏父级选择
    document.getElementById('parentSelectContainer').style.display = 
        type === 'subject' ? 'none' : 'block';
}

// 确认添加
function confirmAdd() {
    const type = document.getElementById('nodeType').value;
    const name = document.getElementById('nodeName').value.trim();
    const parentId = document.getElementById('parentSelect').value;

    if (!name) {
        alert('请输入名称');
        return;
    }

    const newNode = {
        id: nextId++,
        type,
        name,
        children: []
    };

    // 查找父节点并添加
    function findNode(nodes, id) {
        for (const node of nodes) {
            if (node.id == id) return node;
            if (node.children) {
                const found = findNode(node.children, id);
                if (found) return found;
            }
        }
    }

    if (type !== 'subject') {
        const parentNode = findNode(treeData, parentId);
        if (parentNode) {
            parentNode.children = parentNode.children || [];
            parentNode.children.push(newNode);
        }
    } else {
        treeData.push(newNode);
    }

    renderTree(treeData, document.getElementById('directoryTree'));
    hideModal();
}

// 删除节点
function deleteNode(id) {
    if (!confirm('确定要删除该节点及其所有子节点吗？')) return;
    
    function removeNode(nodes) {
        for (let i = nodes.length - 1; i >= 0; i--) {
            if (nodes[i].id === id) {
                nodes.splice(i, 1);
                return true;
            }
            if (nodes[i].children && removeNode(nodes[i].children)) {
                return true;
            }
        }
        return false;
    }

    removeNode(treeData);
    renderTree(treeData, document.getElementById('directoryTree'));
}

// 隐藏模态框
function hideModal() {
    document.getElementById('addModal').style.display = 'none';
    document.getElementById('nodeName').value = '';
}

// 初始化渲染
document.addEventListener('DOMContentLoaded', () => {
    renderTree(treeData, document.getElementById('directoryTree'));
});
</script>
</body>
</html>
